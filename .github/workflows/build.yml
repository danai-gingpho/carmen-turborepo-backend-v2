name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    services:
      turbo-cache:
        image: ducktors/turborepo-remote-cache:latest
        ports:
          - 3333:3000
        env:
          STORAGE_PROVIDER: s3
          S3_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          S3_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: bun-cache
          S3_REGION: ap-southeast-2
          TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    strategy:
      fail-fast: false
      matrix:
        service:
          - backend-gateway
          - micro-business
          - micro-cronjob
          - micro-file
          - micro-keycloak-api
          - micro-notification

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --ignore-scripts

      - name: Build packages & app (with remote cache)
        run: |
          bunx turbo run build:package build --api="http://localhost:3333" --token="${{ secrets.TURBO_TOKEN }}" --team="carmen"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          platforms: linux/arm64
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.meta.outputs.short_sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy-ec2:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: production

    steps:
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.INSTANCE_HOST }}
          username: ${{ secrets.INSTANCE_USER }}
          key: ${{ secrets.INSTANCE_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            # Load shell profile for PATH
            source ~/.bashrc 2>/dev/null || source ~/.bash_profile 2>/dev/null || true
            export PATH="/usr/local/bin:/usr/bin:/bin:$PATH"

            # Set Variables
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}
            export ECR_REGISTRY=${{ secrets.AWS_ECR_REGISTRY }}
            export IMAGE_PREFIX=${{ secrets.DOCKER_IMAGE_PREFIX }}
            export IMAGE_TAG=$(echo "${{ github.sha }}" | cut -c1-7) 

            # Login to ECR
            aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

            # Manage Project Directory
            PROJECT_DIR="$HOME/carmen-turborepo-backend-v2"
            if [ ! -d "$PROJECT_DIR" ]; then
              git clone https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git $PROJECT_DIR
            fi
            cd $PROJECT_DIR

            # Update Code
            git remote set-url origin https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
            git fetch origin main
            git reset --hard origin/main

            # Deployment
            docker-compose pull 
            docker-compose up -d --remove-orphans
            
            # Cleanup & Status
            docker image prune -f
            echo "=== Deployment Complete for SHA: ${GITHUB_SHA::7} ==="
            docker-compose ps