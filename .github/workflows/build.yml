name: Build and Deploy

on:
  push:
    branches: [main, develop-for-ec2]
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-2

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: bun install --ignore-scripts

      - name: Build packages
        run: bun run build:package

      - name: Build
        run: bun run build

  # ===========================================
  # Deploy to VM (main branch)
  # ===========================================
  deploy-vm:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy to VM Server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 2206
          script: |
            cd ~/carmen-turborepo-backend
            git checkout -- .
            git pull origin main
            ./start.sh

  # ===========================================
  # Build Docker Images in Parallel (develop-for-ec2 branch)
  # ===========================================
  build-docker:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop-for-ec2'
    environment: ec2-webservice

    strategy:
      fail-fast: false
      matrix:
        service:
          - backend-gateway
          - micro-authen
          - micro-cluster
          - micro-cronjob
          - micro-file
          - micro-keycloak-api
          - micro-license
          - micro-log
          - micro-notification
          - micro-reports
          - micro-tenant-inventory
          - micro-tenant-master
          - micro-tenant-procurement
          - micro-tenant-recipe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ vars.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.meta.outputs.short_sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ vars.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy-ec2:
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/develop-for-ec2'
    environment: ec2-webservice

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            # Configure AWS CLI
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=${{ vars.AWS_REGION || 'ap-southeast-2' }}

            # Login to ECR
            aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin ${{ vars.AWS_ECR_REGISTRY }}

            # Navigate to project directory
            cd ~/carmen-turborepo-backend

            # Pull latest code
            git checkout -- .
            git pull origin develop-for-ec2

            # Set environment variables for docker-compose
            export IMAGE_TAG=latest
            export ECR_REGISTRY=${{ vars.AWS_ECR_REGISTRY }}
            export IMAGE_PREFIX=${{ vars.DOCKER_IMAGE_PREFIX }}

            # Pull latest images
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-backend-gateway:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-authen:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-cluster:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-license:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-reports:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-file:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-keycloak-api:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-tenant-inventory:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-tenant-master:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-tenant-procurement:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-tenant-recipe:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-log:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-notification:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-cronjob:latest

            # Stop and remove existing containers
            docker-compose -f docker-compose.prod.yml down --remove-orphans || true

            # Start services with new images
            docker-compose -f docker-compose.prod.yml up -d

            # Clean up old images
            docker image prune -af --filter "until=24h"

            # Show running containers
            echo "=== Deployment Complete ==="
            docker-compose -f docker-compose.prod.yml ps
