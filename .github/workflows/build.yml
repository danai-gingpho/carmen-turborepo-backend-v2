name: Build and Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-2

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      - name: Install dependencies
        run: bun install --ignore-scripts

      - name: Build packages
        run: bun run build:package

      - name: Build
        run: bun run build

  build-docker:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    strategy:
      fail-fast: false
      matrix:
        service:
          - backend-gateway
          - micro-business
          - micro-cronjob
          - micro-file
          - micro-keycloak-api
          - micro-notification
          - micro-reports

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate image metadata
        id: meta
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:${{ steps.meta.outputs.short_sha }}
            ${{ steps.login-ecr.outputs.registry }}/${{ secrets.DOCKER_IMAGE_PREFIX }}-${{ matrix.service }}:latest
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  deploy-ec2:
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.INSTANCE_HOST }}
          username: ${{ secrets.INSTANCE_USER }}
          key: ${{ secrets.INSTANCE_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            # Configure AWS CLI
            export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            export AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }}

            # Login to ECR
            aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin ${{ secrets.AWS_ECR_REGISTRY }}

            # Clone repo if not exists, otherwise pull latest
            if [ ! -d ~/carmen-turborepo-backend-v2 ]; then
              git clone https://github.com/${{ github.repository }}.git ~/carmen-turborepo-backend-v2
            fi

            # Navigate to project directory
            cd ~/carmen-turborepo-backend-v2

            # Pull latest code
            git checkout -- .
            git pull origin main

            # Set environment variables for docker-compose
            export IMAGE_TAG=latest
            export ECR_REGISTRY=${{ secrets.AWS_ECR_REGISTRY }}
            export IMAGE_PREFIX=${{ secrets.DOCKER_IMAGE_PREFIX }}

            # Pull latest images
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-backend-gateway:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-business:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-cronjob:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-file:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-keycloak-api:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-notification:latest
            docker pull ${ECR_REGISTRY}/${IMAGE_PREFIX}-micro-reports:latest

            # Stop and remove existing containers
            docker compose -f docker-compose.yml down --remove-orphans || true

            # Start services with new images
            docker compose -f docker-compose.yml up -d

            # Clean up old images
            docker image prune -af --filter "until=24h"

            # Show running containers
            echo "=== Deployment Complete ==="
            docker compose -f docker-compose.yml ps
